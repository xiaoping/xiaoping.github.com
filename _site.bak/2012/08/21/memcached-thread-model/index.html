
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>memcached的线程模型</title>
    <meta name="description" content="">
    <meta name="author" content="zerd liu">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/syntax.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">百度运维团队技术博客</a>
        </div>
        <br />
        <br />
          <ul class="nav">
            <li><a href="/">日志</a></li>
            <li><a href="/archive.html">存档</a></li>
            <li><a href="/join-us.html">招聘</a></li>
            <li><a href="/about.html">关于</a></li>
          </ul>
      </div>
    </div>

    <div class="container">

    <br />
      <div class="content">
        
<div class="page-header">
  <h1>memcached的线程模型 <small>Supporting tagline</small></h1>
</div>

<div class="row">
  <div class="span9">
    <div class="abstract">Memcached 是一个高性能的内存对象缓存系统，经典的场景是用于动态Web应用以减轻数据库负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高动态、数据库驱动网站的速度。这里简要介绍一下memcached的线程模型。</div>
    <br />
    <br />
    <h2 id='memcached'>Memcached数据结构</h2>

<p>memcached的多线程主要是通过实例化多个libevent实现的,分别是一个主线程和n个workers线程。每个线程都是一个单独的libevent实例,主线程eventloop负责处理监听fd，监听客户端的建立连接请求，以及accept连接，将已建立的连接round robin到各个worker。workers线程负责处理已经建立好的连接的读写等事件。”one event loop per thread”.</p>

<p>首先看下主要的数据结构</p>

<p><code>thread.c</code></p>

<p>CQ_ITEM是主线程accept后返回的已建立连接的fd的封装。</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>CQ是一个管理CQ_ITEM的单向链表 Liquid error: No such file or directory - posix_spawnp</p>

<p>LIBEVENT_THREAD 是memcached里的线程结构的封装，可以看到每个线程都包含一个CQ队列，一条通知管道pipe和一个libevent的实例event_base。</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>Memcached对每个网络连接的封装conn</p>

<p>Liquid error: No such file or directory - posix_spawnp memcached主要通过设置/转换连接的不同状态，来处理事件（核心函数是drive_machine，连接的状态机）。</p>

<h2 id='memcached'>Memcached线程处理流程</h2>

<p><code>Memcached.c</code> 里main函数，先对主线程的libevent实例进行初始化, 然后初始化所有的workers线程，并启动。接着主线程调用server_socket（这里只分析tcp的情况）创建监听socket，绑定地址，设置非阻塞模式并注册监听socket的libevent 读事件等一系列操作。最后主线程调用event_base_loop接收外来连接请求。</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>最后看看memcached网络事件处理的最核心部分- drive_machine drive_machine是多线程环境执行的，主线程和workers都会执行drive_machine。</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>drive_machine主要是通过当前连接的state来判断该进行何种处理，因为通过libevent注册了读写事件后回调的都是这个核心函数，所以实际上我们在注册libevent相应事件时，会同时把事件状态写到该conn结构体里，libevent进行回调时会把该conn结构作为参数传递过来，就是该方法的形参。 连接的状态枚举如下。</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>实际对于case conn_listening:这种情况是主线程自己处理的，workers线程永远不会执行此分支我们看到主线程进行了accept后调用了</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>这个函数就是通知workers线程的地方，看看</p>

<p>Liquid error: No such file or directory - posix_spawnp 可以清楚的看到，主线程首先创建了一个新的CQ_ITEM，然后通过round robin策略选择了一个thread并通过cq_push将这个CQ_ITEM放入了该线程的CQ队列里，那么对应的workers线程是怎么知道的呢? 就是通过 Liquid error: No such file or directory - posix_spawnp</p>

<p>向该线程管道写了1字节数据，则该线程的libevent立即回调了thread_libevent_process方法（上面已经描述过）。 然后那个线程取出item,注册读时间，当该条连接上有数据时，最终也会回调drive_machine方法，也就是drive_machine方法的 case conn_read:等全部是workers处理的，主线程只处理conn_listening 建立连接这个。 memcached的这套多线程event机制很值得设计linux后端网络程序时参考。</p>

<h2 id='id110'>参考文献</h2>

<ul>
<li><a href='http://www.iteye.com/topic/344172'>memcache源码分析&#8211;线程模型</a></li>

<li><a href='http://blog.csdn.net/bokee/article/details/6670550'>memcached结构分析——线程模型</a></li>

<li><a href='http://basiccoder.com/thread-model-and-state-machine-of-memcached.html'>Memcached的线程模型及状态机</a></li>
</ul>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2012/08/21/disk-to-memory" title="系统优化--磁盘缓存放入内存">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2012/08/24/articles-2" title="荐文二则-2">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span3">
    
<div class="sidebar">

  <div class="sidebar_corner">
<a href="/atom.xml" class="feed-link" title="RSS订阅"><img
src="http://mini-rssl.overgrid.com/mini_rss.png"
alt="RSS feed" /></a>
  </div>

  <div class="sidebar_corner">
  <h2>最近日志</h2>
  </br>
  
        <ul><li><a href="/2012/12/07/release-engineering-at-facebook">[译文]Release Engineering at Facebook </a></li></ul>
  
        <ul><li><a href="/2012/09/20/how-complex-systems-fail">[全文转载]How complex systems fail </a></li></ul>
  
        <ul><li><a href="/2012/09/20/google-spanner">[全文转载]Google Spanner原理- 全球级的分布式数据库 </a></li></ul>
  
        <ul><li><a href="/2012/09/11/find-architect-2012-q4">寻找未来的架构师 </a></li></ul>
  
        <ul><li><a href="/2012/09/04/puppet-vs-capistrano">[译文]puppet和capistrano 简要的对比 </a></li></ul>
  
        <ul><li><a href="/2012/08/26/stallman-facts">[译文]stallman其人轶事 </a></li></ul>
  
        <ul><li><a href="/2012/08/26/how-to-write-post-for-this-site">本站供稿须知 </a></li></ul>
  
        <ul><li><a href="/2012/08/25/shell-tricks">bash的常用功能和技巧 </a></li></ul>
  
        <ul><li><a href="/2012/08/25/how-to-be-a-good-operation-engineer">如何做一名优秀的运维工程师--职称能力要求解读 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/ssh-hang-solved">ssh hang 问题追查 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/mysql-timeout">mysql timeout调研与实测 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/articles-2">荐文二则-2 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/memcached-thread-model">memcached的线程模型 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/disk-to-memory">系统优化--磁盘缓存放入内存 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/articles-1">荐文二则 </a></li></ul>
  
        <ul><li><a href="/2012/08/18/mfs-master-core-structrue">MFS master的核心数据结构及内存分配简析 </a></li></ul>
  
        <ul><li><a href="/2012/08/01/ops-book-list">一名运维工程师的读书列表 </a></li></ul>
  
        <ul><li><a href="/2012/07/11/jekyll">用Jekyll写技术博客 </a></li></ul>
  

  </div>

  <div class="sidebar_corner">
  
    
      <h2>相关标签</h2>
      
    
    <ul class="tag_box">
      


  
     
    	<li><a href="/tags.html#memcached-ref">memcached <span>1</span></a></li>
     
    	<li><a href="/tags.html#open source-ref">open source <span>2</span></a></li>
    
  



    </ul>
  
  </div>

  <div class="sidebar_corner">
  <h2>友情链接</h2>
  </br>
    <ul><li><a href="http://www.baidu-tech.com"> 百度搜索研发部官方博客 </a></li></ul>
    <ul><li><a href="http://developer.baidu.com"> 百度开发者中心 </a></li></ul>
    <ul><li><a href="http://box.baidu-tech.com/"> 百度框计算技术交流平台 </a></li></ul>
    <ul><li><a href="http://www.baiduux.com/"> 泛用户体验博客 </a></li></ul>
    <ul><li><a href="http://mux.baidu.com/"> 无线用户体验博客 </a></li></ul>
    <ul><li><a href="http://blog.csdn.net/baiduforum"> 百度互联网技术官方博客 </a></li></ul>


  </div>
</div>

  </div>
</div>


      </div>

      <footer>
        <p>&copy; Baidu OPS. Powered By <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

