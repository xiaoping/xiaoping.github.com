
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>bash的常用功能和技巧</title>
    <meta name="description" content="">
    <meta name="author" content="zerd liu">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/syntax.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">百度运维团队技术博客</a>
        </div>
        <br />
        <br />
          <ul class="nav">
            <li><a href="/">日志</a></li>
            <li><a href="/archive.html">存档</a></li>
            <li><a href="/join-us.html">招聘</a></li>
            <li><a href="/about.html">关于</a></li>
          </ul>
      </div>
    </div>

    <div class="container">

    <br />
      <div class="content">
        
<div class="page-header">
  <h1>bash的常用功能和技巧 <small>Supporting tagline</small></h1>
</div>

<div class="row">
  <div class="span9">
    <div class="abstract">本文分享了在shell学习和使用中经常用到的一些功能和技巧。</div>
    <br />
    <br />
    <h2 id='id123'>编码规范</h2>

<p>1 对命令的返回值进行判断 2 临时文件采用脚本名加PID标识并清理 <br />3 function内的局部变量使用local限定符 <br />4 显式函数返回return脚本退出exit <br />5 变量名用<code>${}</code>括起来 <br />6 命令替换使用<code>$()</code>而不是反引号 <br />7 将变量写在脚本头或者独立成配置</p>

<h2 id='id124'>参数处理</h2>

<ul>
<li>直接使用$0,$1……，$@，$#</li>

<li>通过eval赋值</li>
</ul>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<ul>
<li>通过set改变环境变量</li>
</ul>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>则可以通过$1的值为var1，$#的值为3。这种方法改变了环境变量，慎重。或者在subshell中使用</p>

<ul>
<li>getopts</li>
</ul>

<h2 id='subshell'>理解subshell/子进程</h2>

<p>子进程可以继承父进程的环境变量 Liquid error: No such file or directory - posix_spawnp</p>

<p>和</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>“|”创建了一个子进程，无法将变量传给父shell</p>

<h2 id='here'>文本使用here文档</h2>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>利用End_mail前面的”-”可以使用tab进行缩进，保持脚本可读</p>

<h2 id='id125'>避免常见陷阱</h2>

<ol>
<li>避免shell参数个数限制</li>
</ol>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<ol>
<li>避免test测试错误</li>
</ol>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>3. 避免变量未初始化错误</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<ol>
<li>避免cd引起路径错误</li>
</ol>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>5. 更加安全的使用$@</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>6. 避免进程异常退出</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<ol>
<li>crontab中的元字符</li>
</ol>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<ol>
<li>规避xargs的默认分割行为</li>
</ol>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>9. 避免拷贝错误：</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='id126'>理解文件描述符</h2>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='id127'>命令分组</h2>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='id128'>字串替换</h2>

<p>说明： #前%后，控制字串截取方式 实例：当前目录下有如下文件</p>

<p><code>host.new offline.new online.new rd.new wugui64.new xferlog.new</code></p>

<p>需要将后缀.new去掉</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='id129'>进程替换</h2>

<p><code>&lt;()</code> 将进程的输出替换为文本做标准输入</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>同时从文件和标准输入获取： Liquid error: No such file or directory - posix_spawnp</p>

<p>另外一种方式</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>实例：diff两台服务器的同一个配置文件 Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='wget'>wget使用</h2>

<ol>
<li>不要随便修改-t -T选项的设置</li>

<li>限制使用<code>*</code>，失败后返回值仍为0</li>

<li>注意加-c和不加-c的程序行为</li>

<li>从线上下载数据要加&#8211;limit-rate=10M</li>
</ol>

<h2 id='ssh'>ssh的使用</h2>

<p>非交互使用ssh，最好加-n参数</p>

<p>file文件的内容为：</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>远程使用vim，加-t参数，分配tty 超时，重试参数 Liquid error: No such file or directory - posix_spawnp 使用rsync前，加&#8211;dry-run参数 scp加-p参数，保持文件时间戳一致，利用浏览器缓存</p>

<h2 id='find'>find的使用</h2>

<p>1. 排除目录 Liquid error: No such file or directory - posix_spawnp 2. 精确判断时间 Liquid error: No such file or directory - posix_spawnp 3. 运行命令 Liquid error: No such file or directory - posix_spawnp</p>

<h2 id='id130'>分离会话</h2>

<p>1 nohup</p>

<p>Liquid error: No such file or directory - posix_spawnp</p>

<p>2 disown：命令敲下去发现忘记nohup了怎么办？使用disown补救 3 screen：在wiki中搜一下</p>

<h2 id='id131'>创建安全和可维护的脚本</h2>

<p>1 供其他进程使用的文件生成时 采用更名再mv的方式 如 Liquid error: No such file or directory - posix_spawnp</p>

<p>2 将函数和配置独立成单独的脚本</p>

<p>3 将不同服务器需要差异对待的变量提取成单独的配置文件</p>

<p>4 日志打印必须包含脚本名<code>basename</code>和时间</p>

<p>5 每步骤必须校验返回值</p>

<p>6 脚本中避免使用<code>*</code></p>

<p>7 保持缩进4个空格</p>

<p>8 过长的命令按照<code>|</code>折行</p>

<p>9 创建目录使用<code>mkdir –p</code></p>

<p>10 如果采用后台运行一定要wait： <code>( command1 ; command2 ) &amp; wait</code></p>

<p>11 对于需要获取命令输出的命令需要将<code>stderr</code>屏蔽到<code>/dev/null</code></p>

<p>12 抽离公共逻辑作为函数或者代码片段（导入变量）</p>

<p>13 保证互斥和脚本实例唯一性</p>

<h2 id='id132'>参考资料</h2>

<ol>
<li><a href='http://tldp.org/LDP/abs/html/'>Abs</a> &#8211; advanced bash scripting guide</li>

<li><a href='http://docstore.mik.ua/orelly/unix/upt/index.htm'>unix power tools</a> &#8211; unix超级工具上、下</li>
</ol>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2012/08/25/how-to-be-a-good-operation-engineer" title="如何做一名优秀的运维工程师--职称能力要求解读">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2012/08/26/how-to-write-post-for-this-site" title="本站供稿须知">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span3">
    
<div class="sidebar">

  <div class="sidebar_corner">
<a href="/atom.xml" class="feed-link" title="RSS订阅"><img
src="http://mini-rssl.overgrid.com/mini_rss.png"
alt="RSS feed" /></a>
  </div>

  <div class="sidebar_corner">
  <h2>最近日志</h2>
  </br>
  
        <ul><li><a href="/2012/12/07/release-engineering-at-facebook">[译文]Release Engineering at Facebook </a></li></ul>
  
        <ul><li><a href="/2012/09/20/how-complex-systems-fail">[全文转载]How complex systems fail </a></li></ul>
  
        <ul><li><a href="/2012/09/20/google-spanner">[全文转载]Google Spanner原理- 全球级的分布式数据库 </a></li></ul>
  
        <ul><li><a href="/2012/09/11/find-architect-2012-q4">寻找未来的架构师 </a></li></ul>
  
        <ul><li><a href="/2012/09/04/puppet-vs-capistrano">[译文]puppet和capistrano 简要的对比 </a></li></ul>
  
        <ul><li><a href="/2012/08/26/stallman-facts">[译文]stallman其人轶事 </a></li></ul>
  
        <ul><li><a href="/2012/08/26/how-to-write-post-for-this-site">本站供稿须知 </a></li></ul>
  
        <ul><li><a href="/2012/08/25/shell-tricks">bash的常用功能和技巧 </a></li></ul>
  
        <ul><li><a href="/2012/08/25/how-to-be-a-good-operation-engineer">如何做一名优秀的运维工程师--职称能力要求解读 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/ssh-hang-solved">ssh hang 问题追查 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/mysql-timeout">mysql timeout调研与实测 </a></li></ul>
  
        <ul><li><a href="/2012/08/24/articles-2">荐文二则-2 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/memcached-thread-model">memcached的线程模型 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/disk-to-memory">系统优化--磁盘缓存放入内存 </a></li></ul>
  
        <ul><li><a href="/2012/08/21/articles-1">荐文二则 </a></li></ul>
  
        <ul><li><a href="/2012/08/18/mfs-master-core-structrue">MFS master的核心数据结构及内存分配简析 </a></li></ul>
  
        <ul><li><a href="/2012/08/01/ops-book-list">一名运维工程师的读书列表 </a></li></ul>
  
        <ul><li><a href="/2012/07/11/jekyll">用Jekyll写技术博客 </a></li></ul>
  

  </div>

  <div class="sidebar_corner">
  
    
      <h2>相关标签</h2>
      
    
    <ul class="tag_box">
      


  
     
    	<li><a href="/tags.html#shell-ref">shell <span>1</span></a></li>
     
    	<li><a href="/tags.html#practice-ref">practice <span>3</span></a></li>
    
  



    </ul>
  
  </div>

  <div class="sidebar_corner">
  <h2>友情链接</h2>
  </br>
    <ul><li><a href="http://www.baidu-tech.com"> 百度搜索研发部官方博客 </a></li></ul>
    <ul><li><a href="http://developer.baidu.com"> 百度开发者中心 </a></li></ul>
    <ul><li><a href="http://box.baidu-tech.com/"> 百度框计算技术交流平台 </a></li></ul>
    <ul><li><a href="http://www.baiduux.com/"> 泛用户体验博客 </a></li></ul>
    <ul><li><a href="http://mux.baidu.com/"> 无线用户体验博客 </a></li></ul>
    <ul><li><a href="http://blog.csdn.net/baiduforum"> 百度互联网技术官方博客 </a></li></ul>


  </div>
</div>

  </div>
</div>


      </div>

      <footer>
        <p>&copy; Baidu OPS. Powered By <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

